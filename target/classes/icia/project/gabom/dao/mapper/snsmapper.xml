<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="icia.project.gabom.dao.IsnstimelineDao">

	<select id="getsnsTimeLine" resultType="snspost">
	<![CDATA[
		SELECT RTOT.rn,SNSP.SNS_POSTS_NUMBER,
		SNSP.SNS_POSTS_WRITER,SNSP.SNS_POSTS_DATE
		,SNSP.SNS_POSTS_EDIT_DATE
		,SNSP.SNS_POSTS_HASHTAG,
SNSP.SNS_POSTS_AUTHORITY,
SNSP.SNS_POSTS_REPORT,
DBMS_LOB.SUBSTR(SNSP.SNS_POSTS_CONTENT,
DBMS_LOB.GETLENGTH(SNSP.SNS_POSTS_CONTENT)) SNS_POSTS_CONTENT
FROM SNS_POSTS SNSP INNER JOIN
(SELECT DISTINCT ROW_NUMBER() 
OVER(ORDER BY tot.SNS_POSTS_DATE desc)
 AS rn,tot.SNS_POSTS_NUMBER,tot.SNS_POSTS_WRITER,tot.SNS_POSTS_DATE
,tot.SNS_POSTS_EDIT_DATE,tot.SNS_POSTS_HASHTAG,tot.SNS_POSTS_AUTHORITY,tot.SNS_POSTS_REPORT,
DBMS_LOB.SUBSTR(SNS_POSTS_CONTENT,
DBMS_LOB.GETLENGTH(SNS_POSTS_CONTENT))
FROM SNS_POSTS tot INNER JOIN(
SELECT SNS_POSTS_NUMBER,SNS_POSTS_WRITER,
SNS_POSTS_DATE,
SNS_POSTS_EDIT_DATE,
SNS_POSTS_HASHTAG,
SNS_POSTS_AUTHORITY,
SNS_POSTS_REPORT,
DBMS_LOB.SUBSTR(SNS_POSTS_CONTENT,
DBMS_LOB.GETLENGTH(SNS_POSTS_CONTENT)) FROM SNS_POSTS
WHERE SNS_POSTS_AUTHORITY=0 and SNS_POSTS_WRITER!=#{id}
UNION
SELECT SP.SNS_POSTS_NUMBER,SP.SNS_POSTS_WRITER,
SP.SNS_POSTS_DATE,
SP.SNS_POSTS_EDIT_DATE,
SP.SNS_POSTS_HASHTAG,
SP.SNS_POSTS_AUTHORITY,
SP.SNS_POSTS_REPORT,
DBMS_LOB.SUBSTR(SP.SNS_POSTS_CONTENT,
DBMS_LOB.GETLENGTH(SP.SNS_POSTS_CONTENT))
FROM SNS_POSTS SP 
INNER JOIN SNS_FRIEND SF 
ON SP.SNS_POSTS_WRITER=SF.FRIEND_ID
WHERE SP.SNS_POSTS_AUTHORITY=1 and SF.FRIEND_MY_ID=#{id} 
or SP.SNS_POSTS_WRITER=#{id} or SP.SNS_POSTS_AUTHORITY=0
UNION
SELECT SP.SNS_POSTS_NUMBER,SP.SNS_POSTS_WRITER,
SP.SNS_POSTS_DATE,
SP.SNS_POSTS_EDIT_DATE,
SP.SNS_POSTS_HASHTAG,
SP.SNS_POSTS_AUTHORITY,
SP.SNS_POSTS_REPORT,
DBMS_LOB.SUBSTR(SP.SNS_POSTS_CONTENT,
DBMS_LOB.GETLENGTH(SP.SNS_POSTS_CONTENT))
FROM SNS_POSTS SP 
INNER JOIN SNS_FRIEND SF 
ON SP.SNS_POSTS_WRITER=SF.FRIEND_ID
WHERE SP.SNS_POSTS_AUTHORITY=1 AND SF.FRIEND_MY_ID=#{id}) re
on tot.SNS_POSTS_NUMBER=re.SNS_POSTS_NUMBER
ORDER by rn desc) RTOT ON SNSP.SNS_POSTS_NUMBER=RTOT.SNS_POSTS_NUMBER
WHERE RTOT.RN<=#{rowNum} ORDER BY RTOT.rn
]]>
	</select>



</mapper>